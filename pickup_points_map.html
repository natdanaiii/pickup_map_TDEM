<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pickup Points Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
  </style>
</head>

<body>
<div id="map"></div>

<script>
  // âœ… Put your CSV filename here (exactly as in the repo)
  // Tip: keeping an English filename is easier, but Thai also works.
  const CSV_FILE = "./pickup_points_TDEM_3.csv";

  // ---- helpers to find columns even if headers change ----
  function pickKey(headers, candidates) {
    const h = headers.map(x => (x || "").toString().trim().toLowerCase());
    for (const c of candidates) {
      const idx = h.indexOf(c.toLowerCase());
      if (idx >= 0) return headers[idx];
    }
    return null;
  }

  function toNum(x) {
    const n = parseFloat((x ?? "").toString().trim());
    return Number.isFinite(n) ? n : null;
  }

  const map = L.map("map", { zoomControl: true }).setView([13.75, 100.55], 10);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  fetch(CSV_FILE)
    .then(r => {
      if (!r.ok) throw new Error("Cannot load CSV: " + r.status + " " + r.statusText);
      return r.text();
    })
    .then(text => {
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = parsed.data;
      const headers = parsed.meta.fields || [];

      // Try to auto-detect columns (edit candidates if needed)
      const kLat  = pickKey(headers, ["lat", "latitude", "Lat", "Latitude"]);
      const kLon  = pickKey(headers, ["lon", "lng", "longitude", "Lon", "Longitude", "Long"]);
      const kRoute = pickKey(headers, ["route", "Route"]);
      const kTime  = pickKey(headers, ["estimate time", "estimate_time", "time", "Time", "Estimated Time", "Estimate Time (Optional)"]);
      const kPickup = pickKey(headers, ["pick up point", "pickup point", "pickup_point", "Pick up point", "Pick up Point"]);

      if (!kLat || !kLon) {
        console.log("Headers:", headers);
        throw new Error("Cannot find lat/lon columns. Check your CSV headers in console.");
      }

      // Group markers by route for toggling
      const routeLayers = {};
      let firstValid = null;

      rows.forEach(row => {
        const lat = toNum(row[kLat]);
        const lon = toNum(row[kLon]);
        if (lat === null || lon === null) return;

        const route = (kRoute ? (row[kRoute] ?? "") : "").toString().trim() || "No Route";
        const time  = (kTime ? (row[kTime] ?? "") : "").toString().trim() || "-";
        const pickup = (kPickup ? (row[kPickup] ?? "") : "").toString().trim() || "-";

        if (!routeLayers[route]) routeLayers[route] = L.layerGroup().addTo(map);

        const popupHtml = `
          <b>Route:</b> ${route}<br>
          <b>Time:</b> ${time}<br>
          <b>Pickup:</b> ${pickup}
        `;

        L.circleMarker([lat, lon], { radius: 5, weight: 2, fillOpacity: 0.8 })
          .bindPopup(popupHtml)
          .addTo(routeLayers[route]);

        if (!firstValid) firstValid = [lat, lon];
      });

      // Layer control
      L.control.layers(null, routeLayers, { collapsed: false }).addTo(map);

      // Fit bounds
      const all = [];
      Object.values(routeLayers).forEach(g => g.eachLayer(m => all.push(m.getLatLng())));
      if (all.length) map.fitBounds(L.latLngBounds(all).pad(0.15));
      else if (firstValid) map.setView(firstValid, 12);
      else alert("No valid lat/lon rows found in CSV.");
    })
    .catch(err => {
      console.error(err);
      alert(err.message);
    });
</script>
</body>
</html>
