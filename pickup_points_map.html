<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pickup Points Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV parser) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .leaflet-control-layers { max-height: 60vh; overflow: auto; }
  </style>
</head>

<body>
<div id="map"></div>

<script>
  // =========================
  // CONFIG
  // =========================
  const CSV_NAME = "pickup_points_TDEM_3.csv";

  // Option A: Load from same GitHub Pages folder (recommended)
  // This builds a correct URL no matter if you open with / or without /
  const pageUrl = window.location.href;
  const baseUrl = pageUrl.endsWith("/")
    ? pageUrl
    : (pageUrl.substring(0, pageUrl.lastIndexOf("/") + 1)); // folder of current page
  const CSV_FILE = new URL(CSV_NAME, baseUrl).toString();

  // Option B (fallback): GitHub raw (uncomment to force use raw)
  // const CSV_FILE = "https://raw.githubusercontent.com/natdanaiii/pickup_map_TDEM/main/pickup_points_TDEM_3.csv";

  // =========================
  // HELPERS
  // =========================
  function norm(s) {
    return (s ?? "").toString().trim().toLowerCase();
  }

  // Find a header by trying multiple candidate names
  function pickKey(headers, candidates) {
    const h = headers.map(x => norm(x));
    for (const c of candidates) {
      const idx = h.indexOf(norm(c));
      if (idx >= 0) return headers[idx];
    }
    // also try "contains" match (for headers like "Estimate Time (Optional)")
    for (const c of candidates) {
      const cc = norm(c);
      for (let i = 0; i < h.length; i++) {
        if (h[i].includes(cc)) return headers[i];
      }
    }
    return null;
  }

  function toNum(x) {
    const n = parseFloat((x ?? "").toString().trim());
    return Number.isFinite(n) ? n : null;
  }

  // =========================
  // MAP SETUP
  // =========================
  const map = L.map("map", { zoomControl: true }).setView([13.75, 100.55], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // =========================
  // LOAD + DRAW
  // =========================
  fetch(CSV_FILE, { cache: "no-store" })
    .then(r => {
      if (!r.ok) throw new Error("Cannot load CSV: " + r.status + " " + r.statusText + "\nURL: " + CSV_FILE);
      return r.text();
    })
    .then(text => {
      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true
      });

      const rows = parsed.data || [];
      const headers = parsed.meta?.fields || [];

      // ---- auto-detect your columns (edit candidates if your headers differ) ----
      const kLat   = pickKey(headers, ["lat", "latitude"]);
      const kLon   = pickKey(headers, ["lon", "lng", "longitude"]);
      const kRoute = pickKey(headers, ["route"]);
      const kTime  = pickKey(headers, ["estimate time", "time"]);
      const kPickup = pickKey(headers, ["pick up point", "pickup point", "pickup_point"]);

      if (!kLat || !kLon) {
        console.log("CSV headers:", headers);
        throw new Error("Cannot find lat/lon columns. Open DevTools Console to see headers.");
      }

      // Group markers by route so you can toggle routes
      const routeLayers = {};
      const allLatLng = [];

      rows.forEach(row => {
        const lat = toNum(row[kLat]);
        const lon = toNum(row[kLon]);
        if (lat === null || lon === null) return;

        const route = (kRoute ? (row[kRoute] ?? "") : "").toString().trim() || "No Route";
        const time  = (kTime ? (row[kTime] ?? "") : "").toString().trim() || "-";
        const pickup = (kPickup ? (row[kPickup] ?? "") : "").toString().trim() || "-";

        if (!routeLayers[route]) {
          routeLayers[route] = L.layerGroup().addTo(map);
        }

        const popupHtml = `
          <b>Route:</b> ${route}<br>
          <b>Time:</b> ${time}<br>
          <b>Pickup:</b> ${pickup}
        `;

        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          weight: 2,
          fillOpacity: 0.8
        }).bindPopup(popupHtml);

        marker.addTo(routeLayers[route]);
        allLatLng.push([lat, lon]);
      });

      // Add route toggle control
      L.control.layers(null, routeLayers, { collapsed: false }).addTo(map);

      // Zoom to all points
      if (allLatLng.length) {
        map.fitBounds(allLatLng, { padding: [30, 30] });
      } else {
        alert("No valid lat/lon rows found in the CSV.");
      }
    })
    .catch(err => {
      console.error(err);
      alert(err.message);
    });
</script>
</body>
</html>
